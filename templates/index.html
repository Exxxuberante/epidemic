<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../static/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <title>Эпидемиологический анализ</title>
</head>

<body>
    <!-- Модальное окно лоадера -->
    <div id="loadingModal" class="loading-modal hidden">
        <div class="loading-backdrop"></div>
        <div class="loading-content">
            <div class="loading-spinner">
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
            </div>
            <h3>Выполняется расчет...</h3>
            <p>Обрабатываем эпидемиологические данные</p>
            <div class="loading-progress">
                <div class="progress-bar">
                    <div class="progress-fill"></div>
                </div>
                <span class="progress-text">Анализ параметров модели</span>
            </div>
        </div>
    </div>

    <header class="header">
        <div class="header-content">
            <h1><i class="fas fa-chart-line"></i> Анализ эпидемиологической ситуации</h1>
            <div class="header-actions">
                <button id="saveValuesToJson" class="btn-secondary">
                    <i class="fas fa-save"></i> Сохранить
                </button>
                <button id="loadValuesFromJson" class="btn-secondary">
                    <i class="fas fa-folder-open"></i> Загрузить
                </button>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="main-content">
            <section class="card parameters-card">
                <h2><i class="fas fa-sliders-h"></i> Исследуемые показатели</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Параметр</th>
                                <th>Значение</th>
                                <th>Предел</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="param-label">L<sub>1</sub>:</span> Летальность</td>
                                <td><input type="number" class="input-value" id="L1" placeholder="0.0"></td>
                                <td><input type="number" class="input-limit" id="L1_max" placeholder="0.0"></td>
                            </tr>
                            <tr>
                                <td><span class="param-label">L<sub>2</sub>:</span> Численность инфицированных</td>
                                <td><input type="number" class="input-value" id="L2" placeholder="0.0"></td>
                                <td><input type="number" class="input-limit" id="L2_max" placeholder="0.0"></td>
                            </tr>
                            <tr>
                                <td><span class="param-label">L<sub>3</sub>:</span> Численность населения региона</td>
                                <td><input type="number" class="input-value" id="L3" placeholder="0.0"></td>
                                <td><input type="number" class="input-limit" id="L3_max" placeholder="0.0"></td>
                            </tr>
                            <tr>
                                <td><span class="param-label">L<sub>4</sub>:</span> Численность госпитализированных</td>
                                <td><input type="number" class="input-value" id="L4" placeholder="0.0"></td>
                                <td><input type="number" class="input-limit" id="L4_max" placeholder="0.0"></td>
                            </tr>
                            <tr>
                                <td><span class="param-label">L<sub>5</sub>:</span> Изолированность</td>
                                <td><input type="number" class="input-value" id="L5" placeholder="0.0"></td>
                                <td><input type="number" class="input-limit" id="L5_max" placeholder="0.0"></td>
                            </tr>
                            <tr>
                                <td><span class="param-label">L<sub>6</sub>:</span> Скорость распространения</td>
                                <td><input type="number" class="input-value" id="L6" placeholder="0.0"></td>
                                <td><input type="number" class="input-limit" id="L6_max" placeholder="0.0"></td>
                            </tr>
                            <tr>
                                <td><span class="param-label">L<sub>7</sub>:</span> Доступность лекарства</td>
                                <td><input type="number" class="input-value" id="L7" placeholder="0.0"></td>
                                <td><input type="number" class="input-limit" id="L7_max" placeholder="0.0"></td>
                            </tr>
                            <tr>
                                <td><span class="param-label">L<sub>8</sub>:</span> Тяжесть симптомов</td>
                                <td><input type="number" class="input-value" id="L8" placeholder="0.0"></td>
                                <td><input type="number" class="input-limit" id="L8_max" placeholder="0.0"></td>
                            </tr>
                            <tr>
                                <td><span class="param-label">L<sub>9</sub>:</span> Количество умерших от заболевания</td>
                                <td><input type="number" class="input-value" id="L9" placeholder="0.0"></td>
                                <td><input type="number" class="input-limit" id="L9_max" placeholder="0.0"></td>
                            </tr>
                            <tr>
                                <td><span class="param-label">L<sub>10</sub>:</span> Уровень медицины</td>
                                <td><input type="number" class="input-value" id="L10" placeholder="0.0"></td>
                                <td><input type="number" class="input-limit" id="L10_max" placeholder="0.0"></td>
                            </tr>
                            <tr>
                                <td><span class="param-label">L<sub>11</sub>:</span> Длительность инкубационного периода</td>
                                <td><input type="number" class="input-value" id="L11" placeholder="0.0"></td>
                                <td><input type="number" class="input-limit" id="L11_max" placeholder="0.0"></td>
                            </tr>
                            <tr>
                                <td><span class="param-label">L<sub>12</sub>:</span> Длительность периода полного развития болезни</td>
                                <td><input type="number" class="input-value" id="L12" placeholder="0.0"></td>
                                <td><input type="number" class="input-limit" id="L12_max" placeholder="0.0"></td>
                            </tr>
                            <tr>
                                <td><span class="param-label">L<sub>13</sub>:</span> Длительность реабилитационного периода</td>
                                <td><input type="number" class="input-value" id="L13" placeholder="0.0"></td>
                                <td><input type="number" class="input-limit" id="L13_max" placeholder="0.0"></td>
                            </tr>
                            <tr>
                                <td><span class="param-label">L<sub>14</sub>:</span> Устойчивость вируса к лекарствам</td>
                                <td><input type="number" class="input-value" id="L14" placeholder="0.0"></td>
                                <td><input type="number" class="input-limit" id="L14_max" placeholder="0.0"></td>
                            </tr>
                            <tr>
                                <td><span class="param-label">L<sub>15</sub>:</span> Степень осложнений заболевания</td>
                                <td><input type="number" class="input-value" id="L15" placeholder="0.0"></td>
                                <td><input type="number" class="input-limit" id="L15_max" placeholder="0.0"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section class="card actions-card">
                <div class="random-section">
                    <div class="random-controls">
                        <button id="random" class="btn-warning">
                            <i class="fas fa-random"></i> Случайные значения
                        </button>
                        <div class="chance-control">
                            <label for="chanceInput">Вероятность нуля:</label>
                            <input type="range" id="chanceInput" min="0" max="1" step="0.01" value="0.9">
                            <span id="chanceValue">0.9</span>
                        </div>
                    </div>
                    <button id="calculate" class="btn-primary">
                        <i class="fas fa-calculator"></i> Вычислить результат
                    </button>
                </div>
            </section>

            <section class="card results-card">
                <h2><i class="fas fa-history"></i> Последние результаты</h2>
                <div id="results" class="results-container">
                    <!-- Результаты будут здесь -->
                </div>
            </section>
        </div>

        <aside class="sidebar">
            <section class="card equations-card">
                <h2><i class="fas fa-square-root-alt"></i> Уравнения модели</h2>
                <div class="table-container">
                    <table>
                        <tbody id="equationsTable">
                            <!-- Уравнения будут здесь -->
                        </tbody>
                    </table>
                </div>
            </section>
        </aside>
    </main>

    <script>
        // Функции для управления лоадером
        function showLoader() {
            const modal = document.getElementById('loadingModal');
            modal.classList.remove('hidden');
            document.body.classList.add('loading');
            
            // Анимированная смена текста прогресса
            const progressTexts = [
                'Анализ параметров модели',
                'Решение дифференциальных уравнений',
                'Построение графиков',
                'Обработка результатов'
            ];
            
            let textIndex = 0;
            const progressText = document.querySelector('.progress-text');
            
            const textInterval = setInterval(() => {
                progressText.textContent = progressTexts[textIndex];
                textIndex = (textIndex + 1) % progressTexts.length;
            }, 1500);
            
            // Сохраняем интервал для очистки
            modal.setAttribute('data-interval', textInterval);
        }

        function hideLoader() {
            const modal = document.getElementById('loadingModal');
            const intervalId = modal.getAttribute('data-interval');
            
            if (intervalId) {
                clearInterval(intervalId);
            }
            
            setTimeout(() => {
                modal.classList.add('hidden');
                document.body.classList.remove('loading');
            }, 500);
        }

        document.addEventListener("DOMContentLoaded", function() {
            const resultDiv = document.getElementById("results");
            const savedResults = JSON.parse(localStorage.getItem("savedResults")) || { results: [] };
            
            savedResults.results.reverse().forEach(result => {
                const resultItem = `
                    <div class="result-item">
                        <img src="data:image/png;base64,${result.img1}" alt="График 1">
                        <img src="data:image/png;base64,${result.img2}" alt="График 2">
                    </div>
                `;
                resultDiv.innerHTML += resultItem;
            });
        });

        async function loadVariables() {
            try {
                const response = await fetch('/get-json');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                return data.functionsInfo;
            } catch (error) {
                console.error('Error loading JSON:', error);
                return [];
            }
        }

        async function generateEquations() {
            const equationsTable = document.getElementById('equationsTable');
            const functionsInfo = await loadVariables();

            functionsInfo.forEach((func, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="equation">
                        f<sub>${index + 1}</sub> = <input type="number" id="a${index + 1}" class="coef-input">L<sub>${func.variable}</sub>(t)<sup>3</sup> +
                        <input type="number" id="b${index + 1}" class="coef-input">L<sub>${func.variable}</sub>(t)<sup>2</sup> +
                        <input type="number" id="c${index + 1}" class="coef-input">L<sub>${func.variable}</sub>(t) +
                        <input type="number" id="d${index + 1}" class="coef-input">
                    </td>
                `;
                equationsTable.appendChild(row);
            });
        }

        document.addEventListener('DOMContentLoaded', generateEquations);

        document.getElementById("random").addEventListener("click", randomizeValues);
        function randomizeValues() {
            const chanceInput = document.getElementById("chanceInput").value;
            const zeroChance = parseFloat(chanceInput);

            function getRandomValue() {
                return Math.random();
            }

            function getConditionalRandom() {
                return Math.random() > zeroChance ? getRandomValue() : 0.0;
            }

            for (let i = 1; i <= 15; i++) {
                var randomVal = getRandomValue().toFixed(2);
                document.getElementById(`L${i}`).value = randomVal;
                document.getElementById(`L${i}_max`).value = randomVal;
            }

            for (let i = 1; i <= 28; i++) {
                document.getElementById(`a${i}`).value = (Math.random() * 0.8 - 0.4).toFixed(3);
                document.getElementById(`b${i}`).value = (Math.random() * 0.6 - 0.3).toFixed(3);
                document.getElementById(`c${i}`).value = (Math.random() * 1.0 - 0.5).toFixed(3);
                document.getElementById(`d${i}`).value = (Math.random() * 0.4 - 0.2).toFixed(3);
            }
        }

        document.getElementById("calculate").addEventListener("click", function() {
            // Показываем лоадер
            showLoader();
            
            const formData = new FormData();
            const startValues = [];
            const maxValues = [];
            const coefs = [];

            for (let i = 1; i <= 15; i++) {
                startValues.push(parseFloat(document.getElementById(`L${i}`).value) || 0);
                maxValues.push(parseFloat(document.getElementById(`L${i}_max`).value) || 0);
            }

            for (let i = 1; i <= 28; i++) {
                coefs.push([
                    parseFloat(document.getElementById(`a${i}`).value) || 0,
                    parseFloat(document.getElementById(`b${i}`).value) || 0,
                    parseFloat(document.getElementById(`c${i}`).value) || 0,
                    parseFloat(document.getElementById(`d${i}`).value) || 0
                ]);
            }

            formData.append('startValues', JSON.stringify(startValues));
            formData.append('maxValues', JSON.stringify(maxValues));
            formData.append('coefs', JSON.stringify(coefs));

            fetch("/calculate/", {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById("results");
                const newResult = `
                    <div class="result-item">
                        <img src="data:image/png;base64,${data.image1}" alt="График 1">
                        <img src="data:image/png;base64,${data.image2}" alt="График 2">
                    </div>
                `;

                resultDiv.innerHTML = newResult + resultDiv.innerHTML;

                const savedResults = JSON.parse(localStorage.getItem("savedResults")) || { results: [] };
                savedResults.results.unshift({ img1: data.image1, img2: data.image2 });
                
                if (savedResults.results.length > 10) {
                    savedResults.results.pop();
                }

                localStorage.setItem("savedResults", JSON.stringify(savedResults));
                
                // Скрываем лоадер после получения результата
                hideLoader();
            })
            .catch(error => {
                console.error('Ошибка:', error);
                hideLoader(); // Скрываем лоадер даже при ошибке
            });
        });

        document.getElementById("saveValuesToJson").addEventListener("click", function saveToJson() {
            const data = {
                startValues: [],
                maxValues: [],
                coefs: []
            };

            for (let i = 1; i <= 15; i++) {
                data.startValues.push(parseFloat(document.getElementById(`L${i}`).value) || 0);
                data.maxValues.push(parseFloat(document.getElementById(`L${i}_max`).value) || 0);
            }

            for (let i = 1; i <= 28; i++) {
                data.coefs.push([
                    parseFloat(document.getElementById(`a${i}`).value) || 0,
                    parseFloat(document.getElementById(`b${i}`).value) || 0,
                    parseFloat(document.getElementById(`c${i}`).value) || 0,
                    parseFloat(document.getElementById(`d${i}`).value) || 0
                ]);
            }

            const jsonData = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonData], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "epidemic_data.json";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        document.getElementById('loadValuesFromJson').addEventListener('click', function() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            fileInput.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    const jsonData = JSON.parse(e.target.result);

                    jsonData.startValues.forEach((value, index) => {
                        document.getElementById(`L${index + 1}`).value = value;
                    });

                    jsonData.maxValues.forEach((value, index) => {
                        document.getElementById(`L${index + 1}_max`).value = value;
                    });

                    jsonData.coefs.forEach((coef, index) => {
                        document.getElementById(`a${index + 1}`).value = coef[0];
                        document.getElementById(`b${index + 1}`).value = coef[1];
                        document.getElementById(`c${index + 1}`).value = coef[2];
                        document.getElementById(`d${index + 1}`).value = coef[3];
                    });
                };
                reader.readAsText(file);
            };
            fileInput.click();
        });

        document.getElementById('chanceInput').addEventListener('input', function() {
            document.getElementById('chanceValue').textContent = this.value;
        });
    </script>
</body>
</html>